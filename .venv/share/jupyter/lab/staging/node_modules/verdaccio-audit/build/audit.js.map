{"version":3,"file":"audit.js","names":["_express","_interopRequireDefault","require","_https","_httpsProxyAgent","_nodeFetch","_core","e","__esModule","default","REGISTRY_DOMAIN","exports","ProxyAudit","pluginUtils","Plugin","constructor","config","options","_config$timeout","enabled","strict_ssl","undefined","timeout","logger","register_middlewares","app","auth","fetchAudit","req","res","_auth$config","headers","requestOptions","agent","https","Agent","rejectUnauthorized","body","JSON","stringify","method","https_proxy","_auth$config2","createHttpsProxyAgent","Object","assign","auditEndpoint","baseUrl","route","path","debug","controller","AbortController","setTimeout","abort","response","fetch","signal","ok","status","send","json","warn","end","error","handleAudit","router","express","Router","post","limit","use"],"sources":["../src/audit.ts"],"sourcesContent":["import express, { Express, Request, Response } from 'express';\nimport https from 'https';\nimport createHttpsProxyAgent from 'https-proxy-agent';\nimport fetch from 'node-fetch';\n\nimport type { Auth } from '@verdaccio/auth';\nimport { pluginUtils } from '@verdaccio/core';\nimport { Logger } from '@verdaccio/types';\n\nimport { ConfigAudit } from './types';\n\n// FUTURE: we should be able to overwrite this\nexport const REGISTRY_DOMAIN = 'https://registry.npmjs.org';\n\nexport default class ProxyAudit\n  extends pluginUtils.Plugin<ConfigAudit>\n  implements pluginUtils.ExpressMiddleware<ConfigAudit, {}, Auth>\n{\n  public enabled: boolean;\n  public logger: Logger;\n  public strict_ssl: boolean;\n  public timeout: number;\n\n  public constructor(config: ConfigAudit, options: pluginUtils.PluginOptions) {\n    super(config, options);\n    this.enabled = config.enabled || false;\n    this.strict_ssl = config.strict_ssl !== undefined ? config.strict_ssl : true;\n    this.timeout = config.timeout ?? 1000 * 60 * 1;\n    this.logger = options.logger;\n  }\n\n  public register_middlewares(app: Express, auth: Auth): void {\n    const fetchAudit = async (\n      req: Request,\n      res: Response & { report_error?: Function }\n    ): Promise<void> => {\n      const headers = req.headers;\n\n      headers['host'] = 'registry.npmjs.org';\n      headers['content-encoding'] = 'gzip,deflate,br';\n\n      let requestOptions: any = {\n        agent: new https.Agent({ rejectUnauthorized: this.strict_ssl }),\n        body: JSON.stringify(req.body),\n        headers,\n        method: req.method,\n      };\n\n      if (auth?.config?.https_proxy) {\n        // we should check whether this works fine after this migration\n        // please notify if anyone is having issues\n        const agent = createHttpsProxyAgent(auth?.config?.https_proxy);\n        requestOptions = Object.assign({}, requestOptions, {\n          agent,\n        });\n      }\n\n      try {\n        const auditEndpoint = `${REGISTRY_DOMAIN}${req.baseUrl}${req.route.path}`;\n        this.logger.debug('fetching audit from ' + auditEndpoint);\n\n        const controller = new AbortController();\n\n        setTimeout(\n          () => controller.abort(`Fetch ${auditEndpoint} timeout ${this.timeout}ms`),\n          this.timeout\n        );\n\n        const response = await fetch(auditEndpoint, {\n          ...requestOptions,\n          signal: controller.signal,\n        });\n\n        if (response.ok) {\n          res.status(response.status).send(await response.json());\n        } else {\n          this.logger.warn('could not fetch audit: ' + JSON.stringify(await response.json()));\n          res.status(response.status).end();\n        }\n      } catch (error) {\n        this.logger.warn('could not fetch audit: ' + error);\n        res.status(500).end();\n      }\n    };\n\n    const handleAudit = async (req: Request, res: Response): Promise<void> => {\n      if (this.enabled) {\n        await fetchAudit(req, res);\n      } else {\n        res.status(500).end();\n      }\n    };\n\n    /* eslint new-cap:off */\n    const router = express.Router();\n    /* eslint new-cap:off */\n\n    router.post('/audits', express.json({ limit: '10mb' }), handleAudit);\n    router.post('/audits/quick', express.json({ limit: '10mb' }), handleAudit);\n\n    router.post('/advisories/bulk', express.json({ limit: '10mb' }), handleAudit);\n\n    app.use('/-/npm/v1/security', router);\n  }\n}\n"],"mappings":"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","ignoreList":[]}