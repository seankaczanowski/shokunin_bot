"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = loadPlugin;
var _debug = _interopRequireDefault(require("debug"));
var _lodash = _interopRequireDefault(require("lodash"));
var _path = _interopRequireDefault(require("path"));
var _constants = require("./constants");
var _logger = require("./logger");
function _interopRequireDefault(e) { return e && e.__esModule ? e : { default: e }; }
const debug = (0, _debug.default)('verdaccio:plugin:loader');

/**
 * Requires a module.
 * @param {*} path the module's path
 * @return {Object}
 */
function tryLoad(path) {
  try {
    debug('loading plugin %s', path);
    return require(path);
  } catch (err) {
    if (err.code === _constants.MODULE_NOT_FOUND) {
      debug('plugin %s not found', path);
      return null;
    }
    _logger.logger.error({
      err: err.msg
    }, 'error loading plugin @{err}');
    throw err;
  }
}
function mergeConfig(appConfig, pluginConfig) {
  return _lodash.default.merge(appConfig, pluginConfig);
}
function isValid(plugin) {
  return _lodash.default.isFunction(plugin) || _lodash.default.isFunction(plugin.default);
}
function isES6(plugin) {
  return Object.keys(plugin).includes('default');
}

// export type PluginGeneric<R, T extends IPlugin<R> = ;

/**
 * Load a plugin following the rules
 * - First try to load from the internal directory plugins (which will disappear soon or later).
 * - If the package is scoped eg: @scope/foo, try to load as a package
 * - A second attempt from the external plugin directory
 * - A third attempt from node_modules, in case to have multiple match as for instance verdaccio-ldap
 * and sinopia-ldap. All verdaccio prefix will have preferences.
 * @param {*} config a reference of the configuration settings
 * @param {*} pluginConfigs
 * @param {*} params a set of params to initialize the plugin
 * @param {*} sanityCheck callback that check the shape that should fulfill the plugin
 * @return {Array} list of plugins
 */
function loadPlugin(config, pluginConfigs = {}, params, sanityCheck, prefix = 'verdaccio') {
  return Object.keys(pluginConfigs).map(pluginId => {
    let plugin;
    const isScoped = pluginId.startsWith('@') && pluginId.includes('/');
    debug('isScoped %s', isScoped);
    if (isScoped) {
      plugin = tryLoad(pluginId);
    }
    const localPlugin = _path.default.resolve(__dirname + '/../plugins', pluginId);
    // try local plugins first
    plugin = tryLoad(localPlugin);

    // try the external plugin directory
    if (plugin === null && config.plugins) {
      const pluginDir = config.plugins;
      const externalFilePlugin = _path.default.resolve(pluginDir, pluginId);
      plugin = tryLoad(externalFilePlugin);

      // npm package
      if (plugin === null && pluginId.match(/^[^\.\/]/)) {
        plugin = tryLoad(_path.default.resolve(pluginDir, `${prefix}-${pluginId}`));
        // compatibility for old sinopia plugins
        if (!plugin) {
          plugin = tryLoad(_path.default.resolve(pluginDir, `sinopia-${pluginId}`));
          if (plugin) {
            _logger.logger.warn({
              name: pluginId
            }, `plugin names that start with sinopia-* will be removed in the future, please rename package to verdaccio-*`);
          }
        }
      }
    }

    // npm package
    if (plugin === null && pluginId.match(/^[^\.\/]/)) {
      plugin = tryLoad(`${prefix}-${pluginId}`);
      // compatibility for old sinopia plugins
      if (!plugin) {
        plugin = tryLoad(`sinopia-${pluginId}`);
      }
      if (plugin) {
        debug('plugin %s is an npm package', pluginId);
      }
    }
    if (plugin === null) {
      plugin = tryLoad(pluginId);
    }

    // relative to config path
    if (plugin === null && pluginId.match(/^\.\.?($|\/)/)) {
      var _config$self_path;
      // compatible with 6.x
      plugin = tryLoad(_path.default.resolve(_path.default.dirname((_config$self_path = config.self_path) !== null && _config$self_path !== void 0 ? _config$self_path : config.configPath), pluginId));
    }
    if (plugin === null) {
      if (isScoped) {
        _logger.logger.error({
          content: pluginId
        }, 'plugin not found. try npm install @{content}');
      } else {
        _logger.logger.error({
          content: pluginId,
          prefix
        }, 'plugin not found. try npm install @{prefix}-@{content}');
      }
      const msg = isScoped ? `
      ${pluginId} plugin not found. try "npm install ${pluginId}"` : `
      ${prefix}-${pluginId} plugin not found. try "npm install ${prefix}-${pluginId}"`;
      throw Error(msg);
    }
    if (!isValid(plugin)) {
      _logger.logger.error({
        content: pluginId
      }, '@{prefix}-@{content} plugin does not have the right code structure');
      throw Error(`"${pluginId}" plugin does not have the right code structure`);
    }

    /* eslint new-cap:off */
    try {
      if (isES6(plugin)) {
        debug('plugin is ES6');
        plugin = new plugin.default(mergeConfig(config, pluginConfigs[pluginId]), params);
      } else {
        debug('plugin is commonJS');
        plugin = plugin(pluginConfigs[pluginId], params);
      }
    } catch (error) {
      plugin = null;
      _logger.logger.error({
        error,
        pluginId
      }, 'error loading a plugin @{pluginId}: @{error}');
    }
    /* eslint new-cap:off */

    if (plugin === null || !sanityCheck(plugin)) {
      if (isScoped) {
        _logger.logger.error({
          content: pluginId
        }, "@{content} doesn't look like a valid plugin");
      } else {
        _logger.logger.error({
          content: pluginId,
          prefix
        }, "@{prefix}-@{content} doesn't look like a valid plugin");
      }
      throw Error(`sanity check has failed, "${pluginId}" is not a valid plugin`);
    }
    if (isScoped) {
      _logger.logger.info({
        content: pluginId
      }, 'plugin successfully loaded: @{content}');
    } else {
      _logger.logger.info({
        content: pluginId,
        prefix
      }, 'plugin successfully loaded: @{prefix}-@{content}');
    }
    return plugin;
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfZGVidWciLCJfaW50ZXJvcFJlcXVpcmVEZWZhdWx0IiwicmVxdWlyZSIsIl9sb2Rhc2giLCJfcGF0aCIsIl9jb25zdGFudHMiLCJfbG9nZ2VyIiwiZSIsIl9fZXNNb2R1bGUiLCJkZWZhdWx0IiwiZGVidWciLCJidWlsZERlYnVnIiwidHJ5TG9hZCIsInBhdGgiLCJlcnIiLCJjb2RlIiwiTU9EVUxFX05PVF9GT1VORCIsImxvZ2dlciIsImVycm9yIiwibXNnIiwibWVyZ2VDb25maWciLCJhcHBDb25maWciLCJwbHVnaW5Db25maWciLCJfIiwibWVyZ2UiLCJpc1ZhbGlkIiwicGx1Z2luIiwiaXNGdW5jdGlvbiIsImlzRVM2IiwiT2JqZWN0Iiwia2V5cyIsImluY2x1ZGVzIiwibG9hZFBsdWdpbiIsImNvbmZpZyIsInBsdWdpbkNvbmZpZ3MiLCJwYXJhbXMiLCJzYW5pdHlDaGVjayIsInByZWZpeCIsIm1hcCIsInBsdWdpbklkIiwiaXNTY29wZWQiLCJzdGFydHNXaXRoIiwibG9jYWxQbHVnaW4iLCJQYXRoIiwicmVzb2x2ZSIsIl9fZGlybmFtZSIsInBsdWdpbnMiLCJwbHVnaW5EaXIiLCJleHRlcm5hbEZpbGVQbHVnaW4iLCJtYXRjaCIsIndhcm4iLCJuYW1lIiwiX2NvbmZpZyRzZWxmX3BhdGgiLCJkaXJuYW1lIiwic2VsZl9wYXRoIiwiY29uZmlnUGF0aCIsImNvbnRlbnQiLCJFcnJvciIsImluZm8iXSwic291cmNlcyI6WyIuLi8uLi9zcmMvbGliL3BsdWdpbi1sb2FkZXIudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGJ1aWxkRGVidWcgZnJvbSAnZGVidWcnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBQYXRoIGZyb20gJ3BhdGgnO1xuXG5pbXBvcnQgeyBwbHVnaW5VdGlscyB9IGZyb20gJ0B2ZXJkYWNjaW8vY29yZSc7XG5pbXBvcnQgeyBDb25maWcgfSBmcm9tICdAdmVyZGFjY2lvL3R5cGVzJztcblxuaW1wb3J0IHsgTU9EVUxFX05PVF9GT1VORCB9IGZyb20gJy4vY29uc3RhbnRzJztcbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gJy4vbG9nZ2VyJztcblxuY29uc3QgZGVidWcgPSBidWlsZERlYnVnKCd2ZXJkYWNjaW86cGx1Z2luOmxvYWRlcicpO1xuXG4vKipcbiAqIFJlcXVpcmVzIGEgbW9kdWxlLlxuICogQHBhcmFtIHsqfSBwYXRoIHRoZSBtb2R1bGUncyBwYXRoXG4gKiBAcmV0dXJuIHtPYmplY3R9XG4gKi9cbmZ1bmN0aW9uIHRyeUxvYWQocGF0aDogc3RyaW5nKTogYW55IHtcbiAgdHJ5IHtcbiAgICBkZWJ1ZygnbG9hZGluZyBwbHVnaW4gJXMnLCBwYXRoKTtcbiAgICByZXR1cm4gcmVxdWlyZShwYXRoKTtcbiAgfSBjYXRjaCAoZXJyOiBhbnkpIHtcbiAgICBpZiAoZXJyLmNvZGUgPT09IE1PRFVMRV9OT1RfRk9VTkQpIHtcbiAgICAgIGRlYnVnKCdwbHVnaW4gJXMgbm90IGZvdW5kJywgcGF0aCk7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gICAgbG9nZ2VyLmVycm9yKHsgZXJyOiBlcnIubXNnIH0sICdlcnJvciBsb2FkaW5nIHBsdWdpbiBAe2Vycn0nKTtcbiAgICB0aHJvdyBlcnI7XG4gIH1cbn1cblxuZnVuY3Rpb24gbWVyZ2VDb25maWcoYXBwQ29uZmlnLCBwbHVnaW5Db25maWcpOiBDb25maWcge1xuICByZXR1cm4gXy5tZXJnZShhcHBDb25maWcsIHBsdWdpbkNvbmZpZyk7XG59XG5cbmZ1bmN0aW9uIGlzVmFsaWQocGx1Z2luKTogYm9vbGVhbiB7XG4gIHJldHVybiBfLmlzRnVuY3Rpb24ocGx1Z2luKSB8fCBfLmlzRnVuY3Rpb24ocGx1Z2luLmRlZmF1bHQpO1xufVxuXG5mdW5jdGlvbiBpc0VTNihwbHVnaW4pOiBib29sZWFuIHtcbiAgcmV0dXJuIE9iamVjdC5rZXlzKHBsdWdpbikuaW5jbHVkZXMoJ2RlZmF1bHQnKTtcbn1cblxuLy8gZXhwb3J0IHR5cGUgUGx1Z2luR2VuZXJpYzxSLCBUIGV4dGVuZHMgSVBsdWdpbjxSPiA9IDtcblxuLyoqXG4gKiBMb2FkIGEgcGx1Z2luIGZvbGxvd2luZyB0aGUgcnVsZXNcbiAqIC0gRmlyc3QgdHJ5IHRvIGxvYWQgZnJvbSB0aGUgaW50ZXJuYWwgZGlyZWN0b3J5IHBsdWdpbnMgKHdoaWNoIHdpbGwgZGlzYXBwZWFyIHNvb24gb3IgbGF0ZXIpLlxuICogLSBJZiB0aGUgcGFja2FnZSBpcyBzY29wZWQgZWc6IEBzY29wZS9mb28sIHRyeSB0byBsb2FkIGFzIGEgcGFja2FnZVxuICogLSBBIHNlY29uZCBhdHRlbXB0IGZyb20gdGhlIGV4dGVybmFsIHBsdWdpbiBkaXJlY3RvcnlcbiAqIC0gQSB0aGlyZCBhdHRlbXB0IGZyb20gbm9kZV9tb2R1bGVzLCBpbiBjYXNlIHRvIGhhdmUgbXVsdGlwbGUgbWF0Y2ggYXMgZm9yIGluc3RhbmNlIHZlcmRhY2Npby1sZGFwXG4gKiBhbmQgc2lub3BpYS1sZGFwLiBBbGwgdmVyZGFjY2lvIHByZWZpeCB3aWxsIGhhdmUgcHJlZmVyZW5jZXMuXG4gKiBAcGFyYW0geyp9IGNvbmZpZyBhIHJlZmVyZW5jZSBvZiB0aGUgY29uZmlndXJhdGlvbiBzZXR0aW5nc1xuICogQHBhcmFtIHsqfSBwbHVnaW5Db25maWdzXG4gKiBAcGFyYW0geyp9IHBhcmFtcyBhIHNldCBvZiBwYXJhbXMgdG8gaW5pdGlhbGl6ZSB0aGUgcGx1Z2luXG4gKiBAcGFyYW0geyp9IHNhbml0eUNoZWNrIGNhbGxiYWNrIHRoYXQgY2hlY2sgdGhlIHNoYXBlIHRoYXQgc2hvdWxkIGZ1bGZpbGwgdGhlIHBsdWdpblxuICogQHJldHVybiB7QXJyYXl9IGxpc3Qgb2YgcGx1Z2luc1xuICovXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiBsb2FkUGx1Z2luPFQgZXh0ZW5kcyBwbHVnaW5VdGlscy5QbHVnaW48VD4+KFxuICBjb25maWc6IENvbmZpZyxcbiAgcGx1Z2luQ29uZmlnczogYW55ID0ge30sXG4gIHBhcmFtczogYW55LFxuICBzYW5pdHlDaGVjazogYW55LFxuICBwcmVmaXg6IHN0cmluZyA9ICd2ZXJkYWNjaW8nXG4pOiBhbnlbXSB7XG4gIHJldHVybiBPYmplY3Qua2V5cyhwbHVnaW5Db25maWdzKS5tYXAoKHBsdWdpbklkOiBzdHJpbmcpOiBwbHVnaW5VdGlscy5QbHVnaW48VD4gPT4ge1xuICAgIGxldCBwbHVnaW47XG4gICAgY29uc3QgaXNTY29wZWQ6IGJvb2xlYW4gPSBwbHVnaW5JZC5zdGFydHNXaXRoKCdAJykgJiYgcGx1Z2luSWQuaW5jbHVkZXMoJy8nKTtcbiAgICBkZWJ1ZygnaXNTY29wZWQgJXMnLCBpc1Njb3BlZCk7XG4gICAgaWYgKGlzU2NvcGVkKSB7XG4gICAgICBwbHVnaW4gPSB0cnlMb2FkKHBsdWdpbklkKTtcbiAgICB9XG5cbiAgICBjb25zdCBsb2NhbFBsdWdpbiA9IFBhdGgucmVzb2x2ZShfX2Rpcm5hbWUgKyAnLy4uL3BsdWdpbnMnLCBwbHVnaW5JZCk7XG4gICAgLy8gdHJ5IGxvY2FsIHBsdWdpbnMgZmlyc3RcbiAgICBwbHVnaW4gPSB0cnlMb2FkKGxvY2FsUGx1Z2luKTtcblxuICAgIC8vIHRyeSB0aGUgZXh0ZXJuYWwgcGx1Z2luIGRpcmVjdG9yeVxuICAgIGlmIChwbHVnaW4gPT09IG51bGwgJiYgY29uZmlnLnBsdWdpbnMpIHtcbiAgICAgIGNvbnN0IHBsdWdpbkRpciA9IGNvbmZpZy5wbHVnaW5zO1xuICAgICAgY29uc3QgZXh0ZXJuYWxGaWxlUGx1Z2luID0gUGF0aC5yZXNvbHZlKHBsdWdpbkRpciwgcGx1Z2luSWQpO1xuICAgICAgcGx1Z2luID0gdHJ5TG9hZChleHRlcm5hbEZpbGVQbHVnaW4pO1xuXG4gICAgICAvLyBucG0gcGFja2FnZVxuICAgICAgaWYgKHBsdWdpbiA9PT0gbnVsbCAmJiBwbHVnaW5JZC5tYXRjaCgvXlteXFwuXFwvXS8pKSB7XG4gICAgICAgIHBsdWdpbiA9IHRyeUxvYWQoUGF0aC5yZXNvbHZlKHBsdWdpbkRpciwgYCR7cHJlZml4fS0ke3BsdWdpbklkfWApKTtcbiAgICAgICAgLy8gY29tcGF0aWJpbGl0eSBmb3Igb2xkIHNpbm9waWEgcGx1Z2luc1xuICAgICAgICBpZiAoIXBsdWdpbikge1xuICAgICAgICAgIHBsdWdpbiA9IHRyeUxvYWQoUGF0aC5yZXNvbHZlKHBsdWdpbkRpciwgYHNpbm9waWEtJHtwbHVnaW5JZH1gKSk7XG4gICAgICAgICAgaWYgKHBsdWdpbikge1xuICAgICAgICAgICAgbG9nZ2VyLndhcm4oXG4gICAgICAgICAgICAgIHsgbmFtZTogcGx1Z2luSWQgfSxcbiAgICAgICAgICAgICAgYHBsdWdpbiBuYW1lcyB0aGF0IHN0YXJ0IHdpdGggc2lub3BpYS0qIHdpbGwgYmUgcmVtb3ZlZCBpbiB0aGUgZnV0dXJlLCBwbGVhc2UgcmVuYW1lIHBhY2thZ2UgdG8gdmVyZGFjY2lvLSpgXG4gICAgICAgICAgICApO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIC8vIG5wbSBwYWNrYWdlXG4gICAgaWYgKHBsdWdpbiA9PT0gbnVsbCAmJiBwbHVnaW5JZC5tYXRjaCgvXlteXFwuXFwvXS8pKSB7XG4gICAgICBwbHVnaW4gPSB0cnlMb2FkKGAke3ByZWZpeH0tJHtwbHVnaW5JZH1gKTtcbiAgICAgIC8vIGNvbXBhdGliaWxpdHkgZm9yIG9sZCBzaW5vcGlhIHBsdWdpbnNcbiAgICAgIGlmICghcGx1Z2luKSB7XG4gICAgICAgIHBsdWdpbiA9IHRyeUxvYWQoYHNpbm9waWEtJHtwbHVnaW5JZH1gKTtcbiAgICAgIH1cbiAgICAgIGlmIChwbHVnaW4pIHtcbiAgICAgICAgZGVidWcoJ3BsdWdpbiAlcyBpcyBhbiBucG0gcGFja2FnZScsIHBsdWdpbklkKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAocGx1Z2luID09PSBudWxsKSB7XG4gICAgICBwbHVnaW4gPSB0cnlMb2FkKHBsdWdpbklkKTtcbiAgICB9XG5cbiAgICAvLyByZWxhdGl2ZSB0byBjb25maWcgcGF0aFxuICAgIGlmIChwbHVnaW4gPT09IG51bGwgJiYgcGx1Z2luSWQubWF0Y2goL15cXC5cXC4/KCR8XFwvKS8pKSB7XG4gICAgICAvLyBjb21wYXRpYmxlIHdpdGggNi54XG4gICAgICBwbHVnaW4gPSB0cnlMb2FkKFBhdGgucmVzb2x2ZShQYXRoLmRpcm5hbWUoY29uZmlnLnNlbGZfcGF0aCA/PyBjb25maWcuY29uZmlnUGF0aCksIHBsdWdpbklkKSk7XG4gICAgfVxuXG4gICAgaWYgKHBsdWdpbiA9PT0gbnVsbCkge1xuICAgICAgaWYgKGlzU2NvcGVkKSB7XG4gICAgICAgIGxvZ2dlci5lcnJvcih7IGNvbnRlbnQ6IHBsdWdpbklkIH0sICdwbHVnaW4gbm90IGZvdW5kLiB0cnkgbnBtIGluc3RhbGwgQHtjb250ZW50fScpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbG9nZ2VyLmVycm9yKFxuICAgICAgICAgIHsgY29udGVudDogcGx1Z2luSWQsIHByZWZpeCB9LFxuICAgICAgICAgICdwbHVnaW4gbm90IGZvdW5kLiB0cnkgbnBtIGluc3RhbGwgQHtwcmVmaXh9LUB7Y29udGVudH0nXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICBjb25zdCBtc2cgPSBpc1Njb3BlZFxuICAgICAgICA/IGBcbiAgICAgICR7cGx1Z2luSWR9IHBsdWdpbiBub3QgZm91bmQuIHRyeSBcIm5wbSBpbnN0YWxsICR7cGx1Z2luSWR9XCJgXG4gICAgICAgIDogYFxuICAgICAgJHtwcmVmaXh9LSR7cGx1Z2luSWR9IHBsdWdpbiBub3QgZm91bmQuIHRyeSBcIm5wbSBpbnN0YWxsICR7cHJlZml4fS0ke3BsdWdpbklkfVwiYDtcbiAgICAgIHRocm93IEVycm9yKG1zZyk7XG4gICAgfVxuXG4gICAgaWYgKCFpc1ZhbGlkKHBsdWdpbikpIHtcbiAgICAgIGxvZ2dlci5lcnJvcihcbiAgICAgICAgeyBjb250ZW50OiBwbHVnaW5JZCB9LFxuICAgICAgICAnQHtwcmVmaXh9LUB7Y29udGVudH0gcGx1Z2luIGRvZXMgbm90IGhhdmUgdGhlIHJpZ2h0IGNvZGUgc3RydWN0dXJlJ1xuICAgICAgKTtcbiAgICAgIHRocm93IEVycm9yKGBcIiR7cGx1Z2luSWR9XCIgcGx1Z2luIGRvZXMgbm90IGhhdmUgdGhlIHJpZ2h0IGNvZGUgc3RydWN0dXJlYCk7XG4gICAgfVxuXG4gICAgLyogZXNsaW50IG5ldy1jYXA6b2ZmICovXG4gICAgdHJ5IHtcbiAgICAgIGlmIChpc0VTNihwbHVnaW4pKSB7XG4gICAgICAgIGRlYnVnKCdwbHVnaW4gaXMgRVM2Jyk7XG4gICAgICAgIHBsdWdpbiA9IG5ldyBwbHVnaW4uZGVmYXVsdChtZXJnZUNvbmZpZyhjb25maWcsIHBsdWdpbkNvbmZpZ3NbcGx1Z2luSWRdKSwgcGFyYW1zKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGRlYnVnKCdwbHVnaW4gaXMgY29tbW9uSlMnKTtcbiAgICAgICAgcGx1Z2luID0gcGx1Z2luKHBsdWdpbkNvbmZpZ3NbcGx1Z2luSWRdLCBwYXJhbXMpO1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICAgIHBsdWdpbiA9IG51bGw7XG4gICAgICBsb2dnZXIuZXJyb3IoeyBlcnJvciwgcGx1Z2luSWQgfSwgJ2Vycm9yIGxvYWRpbmcgYSBwbHVnaW4gQHtwbHVnaW5JZH06IEB7ZXJyb3J9Jyk7XG4gICAgfVxuICAgIC8qIGVzbGludCBuZXctY2FwOm9mZiAqL1xuXG4gICAgaWYgKHBsdWdpbiA9PT0gbnVsbCB8fCAhc2FuaXR5Q2hlY2socGx1Z2luKSkge1xuICAgICAgaWYgKGlzU2NvcGVkKSB7XG4gICAgICAgIGxvZ2dlci5lcnJvcih7IGNvbnRlbnQ6IHBsdWdpbklkIH0sIFwiQHtjb250ZW50fSBkb2Vzbid0IGxvb2sgbGlrZSBhIHZhbGlkIHBsdWdpblwiKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGxvZ2dlci5lcnJvcihcbiAgICAgICAgICB7IGNvbnRlbnQ6IHBsdWdpbklkLCBwcmVmaXggfSxcbiAgICAgICAgICBcIkB7cHJlZml4fS1Ae2NvbnRlbnR9IGRvZXNuJ3QgbG9vayBsaWtlIGEgdmFsaWQgcGx1Z2luXCJcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIHRocm93IEVycm9yKGBzYW5pdHkgY2hlY2sgaGFzIGZhaWxlZCwgXCIke3BsdWdpbklkfVwiIGlzIG5vdCBhIHZhbGlkIHBsdWdpbmApO1xuICAgIH1cblxuICAgIGlmIChpc1Njb3BlZCkge1xuICAgICAgbG9nZ2VyLmluZm8oeyBjb250ZW50OiBwbHVnaW5JZCB9LCAncGx1Z2luIHN1Y2Nlc3NmdWxseSBsb2FkZWQ6IEB7Y29udGVudH0nKTtcbiAgICB9IGVsc2Uge1xuICAgICAgbG9nZ2VyLmluZm8oXG4gICAgICAgIHsgY29udGVudDogcGx1Z2luSWQsIHByZWZpeCB9LFxuICAgICAgICAncGx1Z2luIHN1Y2Nlc3NmdWxseSBsb2FkZWQ6IEB7cHJlZml4fS1Ae2NvbnRlbnR9J1xuICAgICAgKTtcbiAgICB9XG4gICAgcmV0dXJuIHBsdWdpbjtcbiAgfSk7XG59XG4iXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLElBQUFBLE1BQUEsR0FBQUMsc0JBQUEsQ0FBQUMsT0FBQTtBQUNBLElBQUFDLE9BQUEsR0FBQUYsc0JBQUEsQ0FBQUMsT0FBQTtBQUNBLElBQUFFLEtBQUEsR0FBQUgsc0JBQUEsQ0FBQUMsT0FBQTtBQUtBLElBQUFHLFVBQUEsR0FBQUgsT0FBQTtBQUNBLElBQUFJLE9BQUEsR0FBQUosT0FBQTtBQUFrQyxTQUFBRCx1QkFBQU0sQ0FBQSxXQUFBQSxDQUFBLElBQUFBLENBQUEsQ0FBQUMsVUFBQSxHQUFBRCxDQUFBLEtBQUFFLE9BQUEsRUFBQUYsQ0FBQTtBQUVsQyxNQUFNRyxLQUFLLEdBQUcsSUFBQUMsY0FBVSxFQUFDLHlCQUF5QixDQUFDOztBQUVuRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBU0MsT0FBT0EsQ0FBQ0MsSUFBWSxFQUFPO0VBQ2xDLElBQUk7SUFDRkgsS0FBSyxDQUFDLG1CQUFtQixFQUFFRyxJQUFJLENBQUM7SUFDaEMsT0FBT1gsT0FBTyxDQUFDVyxJQUFJLENB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