"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = _default;
var _lodash = _interopRequireDefault(require("lodash"));
var _semver = _interopRequireDefault(require("semver"));
var _constants = require("../../../../lib/constants");
var _logger = require("../../../../lib/logger");
function _interopRequireDefault(e) { return e && e.__esModule ? e : { default: e }; }
const personMatch = (person, search) => {
  if (typeof person === 'string') {
    return person.includes(search);
  }
  if (typeof person === 'object') {
    for (const field of Object.values(person)) {
      if (typeof field === 'string' && field.includes(search)) {
        return true;
      }
    }
  }
  return false;
};
const matcher = function (query) {
  const match = query.match(/author:(.*)/);
  if (match !== null) {
    return function (pkg) {
      return personMatch(pkg.author, match[1]);
    };
  }

  // TODO: maintainer, keywords, boost-exact
  // TODO implement some scoring system for freetext
  return pkg => {
    return ['name', 'displayName', 'description'].map(k => {
      return pkg[k];
    }).filter(x => {
      return x !== undefined;
    }).some(txt => {
      return txt.includes(query);
    });
  };
};
function compileTextSearch(textSearch) {
  const textMatchers = (textSearch || '').split(' ').map(matcher);
  return pkg => textMatchers.every(m => m(pkg));
}
function removeDuplicates(results) {
  const pkgNames = [];
  return results.filter(pkg => {
    var _pkg$package, _pkg$package2;
    if (pkgNames.includes(pkg === null || pkg === void 0 ? void 0 : (_pkg$package = pkg.package) === null || _pkg$package === void 0 ? void 0 : _pkg$package.name)) {
      return false;
    }
    pkgNames.push(pkg === null || pkg === void 0 ? void 0 : (_pkg$package2 = pkg.package) === null || _pkg$package2 === void 0 ? void 0 : _pkg$package2.name);
    return true;
  });
}
function checkAccess(pkg, auth, remoteUser) {
  return new Promise((resolve, reject) => {
    var _pkg$package3;
    auth.allow_access({
      packageName: pkg === null || pkg === void 0 ? void 0 : (_pkg$package3 = pkg.package) === null || _pkg$package3 === void 0 ? void 0 : _pkg$package3.name
    }, remoteUser, function (err, allowed) {
      if (err) {
        if (err.status && String(err.status).match(/^4\d\d$/)) {
          // auth plugin returns 4xx user error,
          // that's equivalent of !allowed basically
          allowed = false;
          return resolve(null);
        } else {
          reject(err);
        }
      } else {
        return resolve(allowed ? pkg : null);
      }
    });
  });
}
async function sendResponse(resultBuf, resultStream, auth, req, from, size) {
  resultStream.destroy();
  const resultsCollection = resultBuf.map(pkg => {
    if (pkg !== null && pkg !== void 0 && pkg.name) {
      return {
        package: pkg,
        // not sure if flags is need it
        flags: {
          unstable: Object.keys(pkg.versions).some(v => _semver.default.satisfies(v, '^1.0.0')) ? undefined : true
        },
        local: true,
        score: {
          final: 1,
          detail: {
            quality: 1,
            popularity: 1,
            maintenance: 0
          }
        },
        searchScore: 100000
      };
    } else {
      return pkg;
    }
  });
  const checkAccessPromises = await Promise.all(removeDuplicates(resultsCollection).map(pkgItem => {
    return checkAccess(pkgItem, auth, req.remote_user);
  }));
  const final = checkAccessPromises.filter(i => !_lodash.default.isNull(i)).slice(from, size);
  _logger.logger.debug(`search results ${final === null || final === void 0 ? void 0 : final.length}`);
  const response = {
    objects: final,
    total: final.length,
    time: new Date().toUTCString()
  };
  _logger.logger.debug(`total response ${final.length}`);
  return response;
}

/**
 * Endpoint for npm search v1
 * req: 'GET /-/v1/search?text=react&size=20&from=0&quality=0.65&popularity=0.98&maintenance=0.5'
 */
function _default(route, auth, storage) {
  route.get('/-/v1/search', async (req, res, next) => {
    // TODO: implement proper result scoring weighted by quality, popularity and maintenance query parameters
    let [text, size, from /* , quality, popularity, maintenance */] = ['text', 'size', 'from' /* , 'quality', 'popularity', 'maintenance' */].map(k => req.query[k]);
    size = parseInt(size) || 20;
    from = parseInt(from) || 0;
    const isInteresting = compileTextSearch(text);
    const resultStream = storage.search(0, {
      req
    });
    let resultBuf = [];
    let completed = false;
    resultStream.on('data', pkg => {
      // packages from the upstreams
      if (_lodash.default.isArray(pkg)) {
        resultBuf = resultBuf.concat(pkg.filter(pkgItem => {
          var _pkgItem$package;
          if (!isInteresting(pkgItem === null || pkgItem === void 0 ? void 0 : pkgItem.package)) {
            return;
          }
          _logger.logger.debug(`[remote] pkg name ${pkgItem === null || pkgItem === void 0 ? void 0 : (_pkgItem$package = pkgItem.package) === null || _pkgItem$package === void 0 ? void 0 : _pkgItem$package.name}`);
          return true;
        }));
      } else {
        // packages from local
        // due compability with `/-/all` we cannot refactor storage.search();
        if (!isInteresting(pkg)) {
          return;
        }
        _logger.logger.debug(`[local] pkg name ${pkg === null || pkg === void 0 ? void 0 : pkg.name}`);
        resultBuf.push(pkg);
      }
    });
    resultStream.on('error', function () {
      _logger.logger.error('search endpoint has failed');
      res.socket.destroy();
    });
    resultStream.on('end', async () => {
      if (!completed) {
        completed = true;
        try {
          const response = await sendResponse(resultBuf, resultStream, auth, req, from, size);
          _logger.logger.info('search endpoint ok results @{total}', {
            total: response.total
          });
          res.status(_constants.HTTP_STATUS.OK).json(response);
        } catch (err) {
          _logger.logger.error('search endpoint has failed @{err}', {
            err
          });
          next(err);
        }
      }
    });
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfbG9kYXNoIiwiX2ludGVyb3BSZXF1aXJlRGVmYXVsdCIsInJlcXVpcmUiLCJfc2VtdmVyIiwiX2NvbnN0YW50cyIsIl9sb2dnZXIiLCJlIiwiX19lc01vZHVsZSIsImRlZmF1bHQiLCJwZXJzb25NYXRjaCIsInBlcnNvbiIsInNlYXJjaCIsImluY2x1ZGVzIiwiZmllbGQiLCJPYmplY3QiLCJ2YWx1ZXMiLCJtYXRjaGVyIiwicXVlcnkiLCJtYXRjaCIsInBrZyIsImF1dGhvciIsIm1hcCIsImsiLCJmaWx0ZXIiLCJ4IiwidW5kZWZpbmVkIiwic29tZSIsInR4dCIsImNvbXBpbGVUZXh0U2VhcmNoIiwidGV4dFNlYXJjaCIsInRleHRNYXRjaGVycyIsInNwbGl0IiwiZXZlcnkiLCJtIiwicmVtb3ZlRHVwbGljYXRlcyIsInJlc3VsdHMiLCJwa2dOYW1lcyIsIl9wa2ckcGFja2FnZSIsIl9wa2ckcGFja2FnZTIiLCJwYWNrYWdlIiwibmFtZSIsInB1c2giLCJjaGVja0FjY2VzcyIsImF1dGgiLCJyZW1vdGVVc2VyIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJfcGtnJHBhY2thZ2UzIiwiYWxsb3dfYWNjZXNzIiwicGFja2FnZU5hbWUiLCJlcnIiLCJhbGxvd2VkIiwic3RhdHVzIiwiU3RyaW5nIiwic2VuZFJlc3BvbnNlIiwicmVzdWx0QnVmIiwicmVzdWx0U3RyZWFtIiwicmVxIiwiZnJvbSIsInNpemUiLCJkZXN0cm95IiwicmVzdWx0c0NvbGxlY3Rpb24iLCJmbGFncyIsInVuc3RhYmxlIiwia2V5cyIsInZlcnNpb25zIiwidiIsInNlbXZlciIsInNhdGlzZmllcyIsImxvY2FsIiwic2NvcmUiLCJmaW5hbCIsImRldGFpbCIsInF1YWxpdHkiLCJwb3B1bGFyaXR5IiwibWFpbnRlbmFuY2UiLCJzZWFyY2hTY29yZSIsImNoZWNrQWNjZXNzUHJvbWlzZXMiLCJhbGwiLCJwa2dJdGVtIiwicmVtb3RlX3VzZXIiLCJpIiwiXyIsImlzTnVsbCIsInNsaWNlIiwibG9nZ2VyIiwiZGVidWciLCJsZW5ndGgiLCJyZXNwb25zZSIsIm9iamVjdHMiLCJ0b3RhbCIsInRpbWUiLCJEYXRlIiwidG9VVENTdHJpbmciLCJfZGVmYXVsdCIsInJvdXRlIiwic3RvcmFnZSIsImdldCIsInJlcyIsIm5leHQiLCJ0ZXh0IiwicGFyc2VJbnQiLCJpc0ludGVyZXN0aW5nIiwiY29tcGxldGVkIiwib24iLCJpc0FycmF5IiwiY29uY2F0IiwiX3BrZ0l0ZW0kcGFja2FnZSIsImVycm9yIiwic29ja2V0IiwiaW5mbyIsIkhUVFBfU1RBVFVTIiwiT0siLCJqc29uIl0sInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vc3JjL2FwaS9lbmRwb2ludC9hcGkvdjEvc2VhcmNoLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgc2VtdmVyIGZyb20gJ3NlbXZlcic7XG5cbmltcG9ydCB7IFBhY2thZ2UgfSBmcm9tICdAdmVyZGFjY2lvL3R5cGVzJztcblxuaW1wb3J0IHsgSFRUUF9TVEFUVVMgfSBmcm9tICcuLi8uLi8uLi8uLi9saWIvY29uc3RhbnRzJztcbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gJy4uLy4uLy4uLy4uL2xpYi9sb2dnZXInO1xuXG50eXBlIFB1Ymxpc2hlck1haW50YWluZXIgPSB7XG4gIHVzZXJuYW1lOiBzdHJpbmc7XG4gIGVtYWlsOiBzdHJpbmc7XG59O1xuXG50eXBlIFBhY2thZ2VSZXN1bHRzID0ge1xuICBuYW1lOiBzdHJpbmc7XG4gIHNjb3BlOiBzdHJpbmc7XG4gIHZlcnNpb246IHN0cmluZztcbiAgZGVzY3JpcHRpb246IHN0cmluZztcbiAgZGF0ZTogc3RyaW5nO1xuICBsaW5rczoge1xuICAgIG5wbTogc3RyaW5nO1xuICAgIGhvbWVwYWdlPzogc3RyaW5nO1xuICAgIHJlcG9zaXRvcnk/OiBzdHJpbmc7XG4gICAgYnVncz86IHN0cmluZztcbiAgfTtcbiAgYXV0aG9yOiB7IG5hbWU6IHN0cmluZyB9O1xuICBwdWJsaXNoZXI6IFB1Ymxpc2hlck1haW50YWluZXI7XG4gIG1haW50YWluZXI6IFB1Ymxpc2hlck1haW50YWluZXI7XG59O1xuXG50eXBlIFNlYXJjaFJlc3VsdCA9IHtcbiAgcGFja2FnZTogUGFja2FnZVJlc3VsdHM7XG4gIGZsYWdzPzogeyB1bnN0YWJsZTogYm9vbGVhbiB8IHZvaWQgfTtcbiAgbG9jYWw/OiBib29sZWFuO1xuICBzY29yZToge1xuICAgIGZpbmFsOiBudW1iZXI7XG4gICAgZGV0YWlsOiB7XG4gICAgICBxdWFsaXR5OiBudW1iZXI7XG4gICAgICBwb3B1bGFyaXR5OiBudW1iZXI7XG4gICAgICBtYWludGVuYW5jZTogbnVtYmVyO1xuICAgIH07XG4gIH07XG4gIHNlYXJjaFNjb3JlOiBudW1iZXI7XG59O1xuXG50eXBlIFNlYXJjaFJlc3VsdHMgPSB7XG4gIG9iamVjdHM6IFNlYXJjaFJlc3VsdFtdO1xuICB0b3RhbDogbnVtYmVyO1xuICB0aW1lOiBzdHJpbmc7XG59O1xuXG5jb25zdCBwZXJzb25NYXRjaCA9IChwZXJzb24sIHNlYXJjaCkgPT4ge1xuICBpZiAodHlwZW9mIHBlcnNvbiA9PT0gJ3N0cmluZycpIHtcbiAgICByZXR1cm4gcGVyc29uLmluY2x1ZGVzKHNlYXJjaCk7XG4gIH1cblxuICBpZiAodHlwZW9mIHBlcnNvbiA9PT0gJ29iamVjdCcpIHtcbiAgICBmb3IgKGNvbnN0IGZpZWxkIG9mIE9iamVjdC52YWx1ZXMocGVyc29uKSkge1xuICAgICAgaWYgKHR5cGVvZiBmaWVsZCA9PT0gJ3N0cmluZycgJiYgZmllbGQuaW5jbHVkZXMoc2VhcmNoKSkge1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICByZXR1cm4gZmFsc2U7XG59O1xuXG5jb25zdCBtYXRjaGVyID0gZnVuY3Rpb24gKHF1ZXJ5KSB7XG4gIGNvbnN0IG1hdGNoID0gcXVlcnkubWF0Y2goL2F1dGhvcjooLiopLyk7XG4gIGlmIChtYXRjaCAhPT0gbnVsbCkge1xuICAgIHJldHVybiBmdW5jdGlvbiAocGtnKSB7XG4gICAgICByZXR1cm4gcGVyc29uTWF0Y2gocGtnLmF1dGhvciwgbWF0Y2hbMV0pO1xuICAgIH07XG4gIH1cblxuICAvLyBUT0RPOiBtYWludGFpbmVyLCBrZXl3b3JkcywgYm9vc3QtZXhhY3RcbiAgLy8gVE9ETyBpbXBsZW1lbnQgc29tZSBzY29yaW5nIHN5c3RlbSBmb3IgZnJlZXRleHRcbiAgcmV0dXJuIChwa2cpID0+IHtcbiAgICByZXR1cm4gWyduYW1lJywgJ2Rpc3BsYXlOYW1lJywgJ2Rlc2NyaXB0aW9uJ11cbiAgICAgIC5tYXAoKGspID0+IHtcbiAgICAgICAgcmV0dXJuIHBrZ1trXTtcbiAgICAgIH0pXG4gICAgICAuZmlsdGVyKCh4KSA9PiB7XG4gICAgICAgIHJldHVybiB4ICE9PSB1bmRlZmluZWQ7XG4gICAgICB9KVxuICAgICAgLnNvbWUoKHR4dCkgPT4ge1xuICAgICAgICByZXR1cm4gdHh0LmluY2x1ZGVzKHF1ZXJ5KTtcbiAgICAgIH0pO1xuICB9O1xufTtcblxuZnVuY3Rpb24gY29tcGlsZVRleHRTZWFyY2godGV4dFNlYXJjaDogc3RyaW5nKTogKHBrZzogUGFja2FnZVJlc3VsdHMpID0+IGJvb2xlYW4ge1xuICBjb25zdCB0ZXh0TWF0Y2hlcnMgPSAodGV4dFNlYXJjaCB8fCAnJykuc3BsaXQoJyAnKS5tYXAobWF0Y2hlcik7XG4gIHJldHVybiAocGtnKSA9PiB0ZXh0TWF0Y2hlcnMuZXZlcnkoKG0pID0+IG0ocGtnKSk7XG59XG5cbmZ1bmN0aW9uIHJlbW92ZUR1cGxpY2F0ZXMocmVzdWx0cykge1xuICBjb25zdCBwa2dOYW1lczogYW55W10gPSBbXTtcbiAgcmV0dXJuIHJlc3VsdHMuZmlsdGVyKChwa2cpID0+IHtcbiAgICBpZiAocGtnTmFtZXMuaW5jbHVkZXMocGtnPy5wYWNrYWdlPy5uYW1lKSkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICBwa2dOYW1lcy5wdXNoKHBrZz8ucGFja2FnZT8ubmFtZSk7XG4gICAgcmV0dXJuIHRydWU7XG4gIH0pO1xufVxuXG5mdW5jdGlvbiBjaGVja0FjY2Vzcyhwa2c6IGFueSwgYXV0aDogYW55LCByZW1vdGVVc2VyKTogUHJvbWlzZTxQYWNrYWdlIHwgbnVsbD4ge1xuICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgIGF1dGguYWxsb3dfYWNjZXNzKHsgcGFja2FnZU5hbWU6IHBrZz8ucGFja2FnZT8ubmFtZSB9LCByZW1vdGVVc2VyLCBmdW5jdGlvbiAoZXJyLCBhbGxvd2VkKSB7XG4gICAgICBpZiAoZXJyKSB7XG4gICAgICAgIGlmIChlcnIuc3RhdHVzICYmIFN0cmluZyhlcnIuc3RhdHVzKS5tYXRjaCgvXjRcXGRcXGQkLykpIHtcbiAgICAgICAgICAvLyBhdXRoIHBsdWdpbiByZXR1cm5zIDR4eCB1c2VyIGVycm9yLFxuICAgICAgICAgIC8vIHRoYXQncyBlcXVpdmFsZW50IG9mICFhbGxvd2VkIGJhc2ljYWxseVxuICAgICAgICAgIGFsbG93ZWQgPSBmYWxzZTtcbiAgICAgICAgICByZXR1cm4gcmVzb2x2ZShudWxsKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZWplY3QoZXJyKTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIHJlc29sdmUoYWxsb3dlZCA/IHBrZyA6IG51bGwpO1xuICAgICAgfVxuICAgIH0pO1xuICB9KTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gc2VuZFJlc3BvbnNlKFxuICByZXN1bHRCdWYsXG4gIHJlc3VsdFN0cmVhbSxcbiAgYXV0aCxcbiAgcmVxLFxuICBmcm9tOiBudW1iZXIsXG4gIHNpemU6IG51bWJlclxuKTogUHJvbWlzZTxTZWFyY2hSZXN1bHRzPiB7XG4gIHJlc3VsdFN0cmVhbS5kZXN0cm95KCk7XG4gIGNvbnN0IHJlc3VsdHNDb2xsZWN0aW9uID0gcmVzdWx0QnVmLm1hcCgocGtnKTogU2VhcmNoUmVzdWx0ID0+IHtcbiAgICBpZiAocGtnPy5uYW1lKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBwYWNrYWdlOiBwa2csXG4gICAgICAgIC8vIG5vdCBzdXJlIGlmIGZsYWdzIGlzIG5lZWQgaXRcbiAgICAgICAgZmxhZ3M6IHtcbiAgICAgICAgICB1bnN0YWJsZTogT2JqZWN0LmtleXMocGtnLnZlcnNpb25zKS5zb21lKCh2KSA9PiBzZW12ZXIuc2F0aXNmaWVzKHYsICdeMS4wLjAnKSlcbiAgICAgICAgICAgID8gdW5kZWZpbmVkXG4gICAgICAgICAgICA6IHRydWUsXG4gICAgICAgIH0sXG4gICAgICAgIGxvY2FsOiB0cnVlLFxuICAgICAgICBzY29yZToge1xuICAgICAgICAgIGZpbmFsOiAxLFxuICAgICAgICAgIGRldGFpbDoge1xuICAgICAgICAgICAgcXVhbGl0eTogMSxcbiAgICAgICAgICAgIHBvcHVsYXJpdHk6IDEsXG4gICAgICAgICAgICBtYWludGVuYW5jZTogMCxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICBzZWFyY2hTY29yZTogMTAwMDAwLFxuICAgICAgfTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHBrZztcbiAgICB9XG4gIH0pO1xuICBjb25zdCBjaGVja0FjY2Vzc1Byb21pc2VzOiBTZWFyY2hSZXN1bHRbXSA9IGF3YWl0IFByb21pc2UuYWxsKFxuICAgIHJlbW92ZUR1cGxpY2F0ZXMocmVzdWx0c0NvbGxlY3Rpb24pLm1hcCgocGtnSXRlbSkgPT4ge1xuICAgICAgcmV0dXJuIGNoZWNrQWNjZXNzKHBrZ0l0ZW0sIGF1dGgsIHJlcS5yZW1vdGVfdXNlcik7XG4gICAgfSlcbiAgKTtcblxuICBjb25zdCBmaW5hbDogU2VhcmNoUmVzdWx0W10gPSBjaGVja0FjY2Vzc1Byb21pc2VzLmZpbHRlcigoaSkgPT4gIV8uaXNOdWxsKGkpKS5zbGljZShmcm9tLCBzaXplKTtcbiAgbG9nZ2VyLmRlYnVnKGBzZWFyY2ggcmVzdWx0cyAke2ZpbmFsPy5sZW5ndGh9YCk7XG5cbiAgY29uc3QgcmVzcG9uc2U6IFNlYXJjaFJlc3VsdHMgPSB7XG4gICAgb2JqZWN0czogZmluYWwsXG4gICAgdG90YWw6IGZpbmFsLmxlbmd0aCxcbiAgICB0aW1lOiBuZXcgRGF0ZSgpLnRvVVRDU3RyaW5nKCksXG4gIH07XG5cbiAgbG9nZ2VyLmRlYnVnKGB0b3RhbCByZXNwb25zZSAke2ZpbmFsLmxlbmd0aH1gKTtcbiAgcmV0dXJuIHJlc3BvbnNlO1xufVxuXG4vKipcbiAqIEVuZHBvaW50IGZvciBucG0gc2VhcmNoIHYxXG4gKiByZXE6ICdHRVQgLy0vdjEvc2VhcmNoP3RleHQ9cmVhY3Qmc2l6ZT0yMCZmcm9tPTAmcXVhbGl0eT0wLjY1JnBvcHVsYXJpdHk9MC45OCZtYWludGVuYW5jZT0wLjUnXG4gKi9cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIChyb3V0ZSwgYXV0aCwgc3RvcmFnZSk6IHZvaWQge1xuICByb3V0ZS5nZXQoJy8tL3YxL3NlYXJjaCcsIGFzeW5jIChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgIC8vIFRPRE86IGltcGxlbWVudCBwcm9wZXIgcmVzdWx0IHNjb3Jpbmcgd2VpZ2h0ZWQgYnkgcXVhbGl0eSwgcG9wdWxhcml0eSBhbmQgbWFpbnRlbmFuY2UgcXVlcnkgcGFyYW1ldGVyc1xuICAgIGxldCBbdGV4dCwgc2l6ZSwgZnJvbSAvKiAsIHF1YWxpdHksIHBvcHVsYXJpdHksIG1haW50ZW5hbmNlICovXSA9IFtcbiAgICAgICd0ZXh0JyxcbiAgICAgICdzaXplJyxcbiAgICAgICdmcm9tJyAvKiAsICdxdWFsaXR5JywgJ3BvcHVsYXJpdHknLCAnbWFpbnRlbmFuY2UnICovLFxuICAgIF0ubWFwKChrKSA9PiByZXEucXVlcnlba10pO1xuXG4gICAgc2l6ZSA9IHBhcnNlSW50KHNpemUpIHx8IDIwO1xuICAgIGZyb20gPSBwYXJzZUludChmcm9tKSB8fCAwO1xuXG4gICAgY29uc3QgaXNJbnRlcmVzdGluZyA9IGNvbXBpbGVUZXh0U2VhcmNoKHRleHQpO1xuXG4gICAgY29uc3QgcmVzdWx0U3RyZWFtID0gc3RvcmFnZS5zZWFyY2goMCwgeyByZXEgfSk7XG4gICAgbGV0IHJlc3VsdEJ1ZiA9IFtdIGFzIGFueTtcbiAgICBsZXQgY29tcGxldGVkID0gZmFsc2U7XG5cbiAgICByZXN1bHRTdHJlYW0ub24oJ2RhdGEnLCAocGtnOiBTZWFyY2hSZXN1bHRbXSB8IFBhY2thZ2VSZXN1bHRzKSA9PiB7XG4gICAgICAvLyBwYWNrYWdlcyBmcm9tIHRoZSB1cHN0cmVhbXNcbiAgICAgIGlmIChfLmlzQXJyYXkocGtnKSkge1xuICAgICAgICByZXN1bHRCdWYgPSByZXN1bHRCdWYuY29uY2F0KFxuICAgICAgICAgIChwa2cgYXMgU2VhcmNoUmVzdWx0W10pLmZpbHRlcigocGtnSXRlbSkgPT4ge1xuICAgICAgICAgICAgaWYgKCFpc0ludGVyZXN0aW5nKHBrZ0l0ZW0/LnBhY2thZ2UpKSB7XG4gICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhgW3JlbW90ZV0gcGtnIG5hbWUgJHtwa2dJdGVtPy5wYWNrYWdlPy5uYW1lfWApO1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgfSlcbiAgICAgICAgKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIHBhY2thZ2VzIGZyb20gbG9jYWxcbiAgICAgICAgLy8gZHVlIGNvbXBhYmlsaXR5IHdpdGggYC8tL2FsbGAgd2UgY2Fubm90IHJlZmFjdG9yIHN0b3JhZ2Uuc2VhcmNoKCk7XG4gICAgICAgIGlmICghaXNJbnRlcmVzdGluZyhwa2cpKSB7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGxvZ2dlci5kZWJ1ZyhgW2xvY2FsXSBwa2cgbmFtZSAkeyhwa2cgYXMgUGFja2FnZVJlc3VsdHMpPy5uYW1lfWApO1xuICAgICAgICByZXN1bHRCdWYucHVzaChwa2cpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgcmVzdWx0U3RyZWFtLm9uKCdlcnJvcicsIGZ1bmN0aW9uICgpIHtcbiAgICAgIGxvZ2dlci5lcnJvcignc2VhcmNoIGVuZHBvaW50IGhhcyBmYWlsZWQnKTtcbiAgICAgIHJlcy5zb2NrZXQuZGVzdHJveSgpO1xuICAgIH0pO1xuXG4gICAgcmVzdWx0U3RyZWFtLm9uKCdlbmQnLCBhc3luYyAoKSA9PiB7XG4gICAgICBpZiAoIWNvbXBsZXRlZCkge1xuICAgICAgICBjb21wbGV0ZWQgPSB0cnVlO1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgc2VuZFJlc3BvbnNlKHJlc3VsdEJ1ZiwgcmVzdWx0U3RyZWFtLCBhdXRoLCByZXEsIGZyb20sIHNpemUpO1xuICAgICAgICAgIGxvZ2dlci5pbmZvKCdzZWFyY2ggZW5kcG9pbnQgb2sgcmVzdWx0cyBAe3RvdGFsfScsIHsgdG90YWw6IHJlc3BvbnNlLnRvdGFsIH0pO1xuICAgICAgICAgIHJlcy5zdGF0dXMoSFRUUF9TVEFUVVMuT0spLmpzb24ocmVzcG9uc2UpO1xuICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICBsb2dnZXIuZXJyb3IoJ3NlYXJjaCBlbmRwb2ludCBoYXMgZmFpbGVkIEB7ZXJyfScsIHsgZXJyIH0pO1xuICAgICAgICAgIG5leHQoZXJyKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuICB9KTtcbn1cbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsSUFBQUEsT0FBQSxHQUFBQyxzQkFBQSxDQUFBQyxPQUFBO0FBQ0EsSUFBQUMsT0FBQSxHQUFBRixzQkFBQSxDQUFBQyxPQUFBO0FBSUEsSUFBQUUsVUFBQSxHQUFBRixPQUFBO0FBQ0EsSUFBQUcsT0FBQSxHQUFBSCxPQUFBO0FBQWdELFNBQUFELHVCQUFBSyxDQUFBLFdBQUFBLENBQUEsSUFBQUEsQ0FBQSxDQUFBQyxVQUFBLEdBQUFELENBQUEsS0FBQUUsT0FBQSxFQUFBRixDQUFBO0FBNkNoRCxNQUFNRyxXQUFXLEdBQUdBLENBQUNDLE1BQU0sRUFB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Q0FBQyxxQkFBcUJQLE9BQU8sYUFBUEEsT0FBTyx3QkFBQTRCLGdCQUFBLEdBQVA1QixPQUFPLENBQUV6QyxPQUFPLGNBQUFxRSxnQkFBQSx1QkFBaEJBLGdCQUFBLENBQWtCcEUsSUFBSSxFQUFFLENBQUM7VUFDM0QsT0FBTyxJQUFJO1FBQ2IsQ0FBQyxDQUNILENBQUM7TUFDSCxDQUFDLE1BQU07UUFDTDtRQUNBO1FBQ0EsSUFBSSxDQUFDK0QsYUFBYSxDQUFDcEYsR0FBRyxDQUFDLEVBQUU7VUFDdkI7UUFDRjtRQUNBbUUsY0FBTSxDQUFDQyxLQUFLLENBQUMsb0JBQXFCcEUsR0FBRyxhQUFIQSxHQUFHLHVCQUFIQSxHQUFHLENBQXFCcUIsSUFBSSxFQUFFLENBQUM7UUFDakVnQixTQUFTLENBQUNmLElBQUksQ0FBQ3RCLEdBQUcsQ0FBQztNQUNyQjtJQUNGLENBQUMsQ0FBQztJQUVGc0MsWUFBWSxDQUFDZ0QsRUFBRSxDQUFDLE9BQU8sRUFBRSxZQUFZO01BQ25DbkIsY0FBTSxDQUFDdUIsS0FBSyxDQUFDLDRCQUE0QixDQUFDO01BQzFDVixHQUFHLENBQUNXLE1BQU0sQ0FBQ2pELE9BQU8sQ0FBQyxDQUFDO0lBQ3RCLENBQUMsQ0FBQztJQUVGSixZQUFZLENBQUNnRCxFQUFFLENBQUMsS0FBSyxFQUFFLFlBQVk7TUFDakMsSUFBSSxDQUFDRCxTQUFTLEVBQUU7UUFDZEEsU0FBUyxHQUFHLElBQUk7UUFDaEIsSUFBSTtVQUNGLE1BQU1mLFFBQVEsR0FBRyxNQUFNbEMsWUFBWSxDQUFDQyxTQUFTLEVBQUVDLFlBQVksRUFBRWQsSUFBSSxFQUFFZSxHQUFHLEVBQUVDLElBQUksRUFBRUMsSUFBSSxDQUFDO1VBQ25GMEIsY0FBTSxDQUFDeUIsSUFBSSxDQUFDLHFDQUFxQyxFQUFFO1lBQUVwQixLQUFLLEVBQUVGLFFBQVEsQ0FBQ0U7VUFBTSxDQUFDLENBQUM7VUFDN0VRLEdBQUcsQ0FBQzlDLE1BQU0sQ0FBQzJELHNCQUFXLENBQUNDLEVBQUUsQ0FBQyxDQUFDQyxJQUFJLENBQUN6QixRQUFRLENBQUM7UUFDM0MsQ0FBQyxDQUFDLE9BQU90QyxHQUFHLEVBQUU7VUFDWm1DLGNBQU0sQ0FBQ3VCLEtBQUssQ0FBQyxtQ0FBbUMsRUFBRTtZQUFFMUQ7VUFBSSxDQUFDLENBQUM7VUFDMURpRCxJQUFJLENBQUNqRCxHQUFHLENBQUM7UUFDWDtNQUNGO0lBQ0YsQ0FBQyxDQUFDO0VBQ0osQ0FBQyxDQUFDO0FBQ0oiLCJpZ25vcmVMaXN0IjpbXX0=