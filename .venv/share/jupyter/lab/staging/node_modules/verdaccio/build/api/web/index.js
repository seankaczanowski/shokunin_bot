"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;
exports.loadTheme = loadTheme;
var _debug = _interopRequireDefault(require("debug"));
var _express = require("express");
var _lodash = _interopRequireDefault(require("lodash"));
var _middleware = require("@verdaccio/middleware");
var _pluginLoader = _interopRequireDefault(require("../../lib/plugin-loader"));
var _api = _interopRequireDefault(require("./api"));
function _interopRequireDefault(e) { return e && e.__esModule ? e : { default: e }; }
const debug = (0, _debug.default)('verdaccio:web');
function loadTheme(config) {
  if (_lodash.default.isNil(config.theme) === false) {
    debug('loading custom ui theme');
    return _lodash.default.head((0, _pluginLoader.default)(config, config.theme, {}, function (plugin) {
      return plugin.staticPath && plugin.manifest && plugin.manifestFiles;
    }, 'verdaccio-theme'));
  }
}
var _default = (config, auth, storage) => {
  const pluginOptions = loadTheme(config) || require('@verdaccio/ui-theme')();
  // eslint-disable-next-line new-cap
  const router = (0, _express.Router)();
  router.use(auth.webUIJWTmiddleware());
  router.use(_middleware.setSecurityWebHeaders);
  // render web
  // @ts-ignore
  router.use('/', (0, _middleware.renderWebMiddleware)(config, null, pluginOptions));
  // web endpoints, search, packages, etc
  router.use((0, _api.default)(auth, storage, config));
  return router;
};
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfZGVidWciLCJfaW50ZXJvcFJlcXVpcmVEZWZhdWx0IiwicmVxdWlyZSIsIl9leHByZXNzIiwiX2xvZGFzaCIsIl9taWRkbGV3YXJlIiwiX3BsdWdpbkxvYWRlciIsIl9hcGkiLCJlIiwiX19lc01vZHVsZSIsImRlZmF1bHQiLCJkZWJ1ZyIsImJ1aWxkRGVidWciLCJsb2FkVGhlbWUiLCJjb25maWciLCJfIiwiaXNOaWwiLCJ0aGVtZSIsImhlYWQiLCJsb2FkUGx1Z2luIiwicGx1Z2luIiwic3RhdGljUGF0aCIsIm1hbmlmZXN0IiwibWFuaWZlc3RGaWxlcyIsIl9kZWZhdWx0IiwiYXV0aCIsInN0b3JhZ2UiLCJwbHVnaW5PcHRpb25zIiwicm91dGVyIiwiUm91dGVyIiwidXNlIiwid2ViVUlKV1RtaWRkbGV3YXJlIiwic2V0U2VjdXJpdHlXZWJIZWFkZXJzIiwicmVuZGVyV2ViTWlkZGxld2FyZSIsIndlYkVuZHBvaW50c0FwaSIsImV4cG9ydHMiXSwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvYXBpL3dlYi9pbmRleC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgYnVpbGREZWJ1ZyBmcm9tICdkZWJ1Zyc7XG5pbXBvcnQgeyBSb3V0ZXIgfSBmcm9tICdleHByZXNzJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5cbmltcG9ydCB7IHJlbmRlcldlYk1pZGRsZXdhcmUsIHNldFNlY3VyaXR5V2ViSGVhZGVycyB9IGZyb20gJ0B2ZXJkYWNjaW8vbWlkZGxld2FyZSc7XG5cbmltcG9ydCBsb2FkUGx1Z2luIGZyb20gJy4uLy4uL2xpYi9wbHVnaW4tbG9hZGVyJztcbmltcG9ydCB3ZWJFbmRwb2ludHNBcGkgZnJvbSAnLi9hcGknO1xuXG5jb25zdCBkZWJ1ZyA9IGJ1aWxkRGVidWcoJ3ZlcmRhY2Npbzp3ZWInKTtcblxuZXhwb3J0IGZ1bmN0aW9uIGxvYWRUaGVtZShjb25maWcpIHtcbiAgaWYgKF8uaXNOaWwoY29uZmlnLnRoZW1lKSA9PT0gZmFsc2UpIHtcbiAgICBkZWJ1ZygnbG9hZGluZyBjdXN0b20gdWkgdGhlbWUnKTtcbiAgICByZXR1cm4gXy5oZWFkKFxuICAgICAgbG9hZFBsdWdpbihcbiAgICAgICAgY29uZmlnLFxuICAgICAgICBjb25maWcudGhlbWUsXG4gICAgICAgIHt9LFxuICAgICAgICBmdW5jdGlvbiAocGx1Z2luKSB7XG4gICAgICAgICAgcmV0dXJuIHBsdWdpbi5zdGF0aWNQYXRoICYmIHBsdWdpbi5tYW5pZmVzdCAmJiBwbHVnaW4ubWFuaWZlc3RGaWxlcztcbiAgICAgICAgfSxcbiAgICAgICAgJ3ZlcmRhY2Npby10aGVtZSdcbiAgICAgIClcbiAgICApO1xuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IChjb25maWcsIGF1dGgsIHN0b3JhZ2UpID0+IHtcbiAgY29uc3QgcGx1Z2luT3B0aW9ucyA9IGxvYWRUaGVtZShjb25maWcpIHx8IHJlcXVpcmUoJ0B2ZXJkYWNjaW8vdWktdGhlbWUnKSgpO1xuICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbmV3LWNhcFxuICBjb25zdCByb3V0ZXIgPSBSb3V0ZXIoKTtcbiAgcm91dGVyLnVzZShhdXRoLndlYlVJSldUbWlkZGxld2FyZSgpKTtcbiAgcm91dGVyLnVzZShzZXRTZWN1cml0eVdlYkhlYWRlcnMpO1xuICAvLyByZW5kZXIgd2ViXG4gIC8vIEB0cy1pZ25vcmVcbiAgcm91dGVyLnVzZSgnLycsIHJlbmRlcldlYk1pZGRsZXdhcmUoY29uZmlnLCBudWxsLCBwbHVnaW5PcHRpb25zKSk7XG4gIC8vIHdlYiBlbmRwb2ludHMsIHNlYXJjaCwgcGFja2FnZXMsIGV0Y1xuICByb3V0ZXIudXNlKHdlYkVuZHBvaW50c0FwaShhdXRoLCBzdG9yYWdlLCBjb25maWcpKTtcbiAgcmV0dXJuIHJvdXRlcjtcbn07XG4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQSxJQUFBQSxNQUFBLEdBQUFDLHNCQUFBLENBQUFDLE9BQUE7QUFDQSxJQUFBQyxRQUFBLEdBQUFELE9BQUE7QUFDQSxJQUFBRSxPQUFBLEdBQUFILHNCQUFBLENBQUFDLE9BQUE7QUFFQSxJQUFBRyxXQUFBLEdBQUFILE9BQUE7QUFFQSxJQUFBSSxhQUFBLEdBQUFMLHNCQUFBLENBQUFDLE9BQUE7QUFDQSxJQUFBSyxJQUFBLEdBQUFOLHNCQUFBLENBQUFDLE9BQUE7QUFBb0MsU0FBQUQsdUJBQUFPLENBQUEsV0FBQUEsQ0FBQSxJQUFBQSxDQUFBLENBQUFDLFVBQUEsR0FBQUQsQ0FBQSxLQUFBRSxPQUFBLEVBQUFGLENBQUE7QUFFcEMsTUFBTUcsS0FBSyxHQUFHLElBQUFDLGNBQVUsRUFBQyxlQUFlLENBQUM7QUFFbEMsU0FBU0MsU0FBU0EsQ0FBQ0MsTUFBTSxFQUFFO0VBQ2hDLElBQUlDLGVBQUMsQ0FBQ0MsS0FBSyxDQUFDRixNQUFNLENBQUNHLEtBQUssQ0FBQyxLQUFLLEtBQUssRUFBRTtJQUNuQ04sS0FBSyxDQUFDLHlCQUF5QixDQUFDO0lBQ2hDLE9BQU9JLGVBQUMsQ0FBQ0csSUFBSSxDQUNYLElBQUFDLHFCQUFVLEVBQ1JMLE1BQU0sRUFDTkEsTUFBTSxDQUFDRyxLQUFLLEVBQ1osQ0FBQyxDQUFDLEVBQ0YsVUFBVUcsTUFBTSxFQUFFO01BQ2hCLE9BQU9BLE1BQU0sQ0FBQ0MsVUFBVSxJQUFJRCxNQUFNLENBQUNFLFFBQVEsSUFBSUYsTUFBTSxDQUFDRyxhQUFhO0lBQ3JFLENBQUMsRUFDRCxpQkFDRixDQUNGLENBQUM7RUFDSDtBQUNGO0FBQUMsSUFBQUMsUUFBQSxHQUVjQSxDQUFDVixNQUFNLEVBQUVXLElBQUksRUFBRUMsT0FBTyxLQUFLO0VBQ3hDLE1BQU1DLGFBQWEsR0FBR2QsU0FBUyxDQUFDQyxNQUFNLENBQUMsSUFBSVosT0FBTyxDQUFDLHFCQUFxQixDQUFDLENBQUMsQ0FBQztFQUMzRTtFQUNBLE1BQU0wQixNQUFNLEdBQUcsSUFBQUMsZUFBTSxFQUFDLENBQUM7RUFDdkJELE1BQU0sQ0FBQ0UsR0FBRyxDQUFDTCxJQUFJLENBQUNNLGtCQUFrQixDQUFDLENBQUMsQ0FBQztFQUNyQ0gsTUFBTSxDQUFDRSxHQUFHLENBQUNFLGlDQUFxQixDQUFDO0VBQ2pDO0VBQ0E7RUFDQUosTUFBTSxDQUFDRSxHQUFHLENBQUMsR0FBRyxFQUFFLElBQUFHLCtCQUFtQixFQUFDbkIsTUFBTSxFQUFFLElBQUksRUFBRWEsYUFBYSxDQUFDLENBQUM7RUFDakU7RUFDQUMsTUFBTSxDQUFDRSxHQUFHLENBQUMsSUFBQUksWUFBZSxFQUFDVCxJQUFJLEVBQUVDLE9BQU8sRUFBRVosTUFBTSxDQUFDLENBQUM7RUFDbEQsT0FBT2MsTUFBTTtBQUNmLENBQUM7QUFBQU8sT0FBQSxDQUFBekIsT0FBQSxHQUFBYyxRQUFBIiwiaWdub3JlTGlzdCI6W119