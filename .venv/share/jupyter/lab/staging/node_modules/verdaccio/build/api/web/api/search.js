"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;
var _searchIndexer = require("@verdaccio/search-indexer");
var _constants = require("../../../lib/constants");
function addSearchWebApi(route, storage, auth) {
  // Search package
  route.get('/-/verdaccio/data/search/:anything', async function (req, _res, next) {
    const term = req.params.anything;
    const indexer = await _searchIndexer.SearchMemoryIndexer.query(term);
    const packages = [];
    const results = indexer.hits;
    const getPackageInfo = function (i) {
      storage.getPackage({
        name: results[i].id,
        uplinksLook: false,
        callback: (err, entry) => {
          if (!err && entry) {
            auth.allow_access({
              packageName: entry.name
            }, req.remote_user, function (err, allowed) {
              if (err || !allowed) {
                return;
              }
              packages.push(entry.versions[entry[_constants.DIST_TAGS].latest]);
            });
          }
          if (i >= results.length - 1) {
            next(packages);
          } else {
            getPackageInfo(i + 1);
          }
        }
      });
    };
    if (results.length) {
      getPackageInfo(0);
    } else {
      next([]);
    }
  });
  return route;
}
var _default = exports.default = addSearchWebApi;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfc2VhcmNoSW5kZXhlciIsInJlcXVpcmUiLCJfY29uc3RhbnRzIiwiYWRkU2VhcmNoV2ViQXBpIiwicm91dGUiLCJzdG9yYWdlIiwiYXV0aCIsImdldCIsInJlcSIsIl9yZXMiLCJuZXh0IiwidGVybSIsInBhcmFtcyIsImFueXRoaW5nIiwiaW5kZXhlciIsIlNlYXJjaE1lbW9yeUluZGV4ZXIiLCJxdWVyeSIsInBhY2thZ2VzIiwicmVzdWx0cyIsImhpdHMiLCJnZXRQYWNrYWdlSW5mbyIsImkiLCJnZXRQYWNrYWdlIiwibmFtZSIsImlkIiwidXBsaW5rc0xvb2siLCJjYWxsYmFjayIsImVyciIsImVudHJ5IiwiYWxsb3dfYWNjZXNzIiwicGFja2FnZU5hbWUiLCJyZW1vdGVfdXNlciIsImFsbG93ZWQiLCJwdXNoIiwidmVyc2lvbnMiLCJESVNUX1RBR1MiLCJsYXRlc3QiLCJsZW5ndGgiLCJfZGVmYXVsdCIsImV4cG9ydHMiLCJkZWZhdWx0Il0sInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2FwaS93ZWIvYXBpL3NlYXJjaC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBSb3V0ZXIgfSBmcm9tICdleHByZXNzJztcblxuaW1wb3J0IHsgU2VhcmNoTWVtb3J5SW5kZXhlciB9IGZyb20gJ0B2ZXJkYWNjaW8vc2VhcmNoLWluZGV4ZXInO1xuaW1wb3J0IHsgTWFuaWZlc3QgfSBmcm9tICdAdmVyZGFjY2lvL3R5cGVzJztcblxuaW1wb3J0IEF1dGggZnJvbSAnLi4vLi4vLi4vbGliL2F1dGgnO1xuaW1wb3J0IHsgRElTVF9UQUdTIH0gZnJvbSAnLi4vLi4vLi4vbGliL2NvbnN0YW50cyc7XG5pbXBvcnQgU3RvcmFnZSBmcm9tICcuLi8uLi8uLi9saWIvc3RvcmFnZSc7XG5pbXBvcnQgeyAkTmV4dEZ1bmN0aW9uVmVyLCAkUmVxdWVzdEV4dGVuZCwgJFJlc3BvbnNlRXh0ZW5kIH0gZnJvbSAnLi4vLi4vLi4vdHlwZXMnO1xuXG5mdW5jdGlvbiBhZGRTZWFyY2hXZWJBcGkocm91dGU6IFJvdXRlciwgc3RvcmFnZTogU3RvcmFnZSwgYXV0aDogQXV0aCk6IFJvdXRlciB7XG4gIC8vIFNlYXJjaCBwYWNrYWdlXG4gIHJvdXRlLmdldChcbiAgICAnLy0vdmVyZGFjY2lvL2RhdGEvc2VhcmNoLzphbnl0aGluZycsXG4gICAgYXN5bmMgZnVuY3Rpb24gKFxuICAgICAgcmVxOiAkUmVxdWVzdEV4dGVuZCxcbiAgICAgIF9yZXM6ICRSZXNwb25zZUV4dGVuZCxcbiAgICAgIG5leHQ6ICROZXh0RnVuY3Rpb25WZXJcbiAgICApOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgIGNvbnN0IHRlcm0gPSByZXEucGFyYW1zLmFueXRoaW5nO1xuICAgICAgY29uc3QgaW5kZXhlciA9IChhd2FpdCBTZWFyY2hNZW1vcnlJbmRleGVyLnF1ZXJ5KHRlcm0pKSBhcyBhbnk7XG4gICAgICBjb25zdCBwYWNrYWdlczogYW55W10gPSBbXTtcbiAgICAgIGNvbnN0IHJlc3VsdHMgPSBpbmRleGVyLmhpdHM7XG5cbiAgICAgIGNvbnN0IGdldFBhY2thZ2VJbmZvID0gZnVuY3Rpb24gKGkpOiB2b2lkIHtcbiAgICAgICAgc3RvcmFnZS5nZXRQYWNrYWdlKHtcbiAgICAgICAgICBuYW1lOiByZXN1bHRzW2ldLmlkLFxuICAgICAgICAgIHVwbGlua3NMb29rOiBmYWxzZSxcbiAgICAgICAgICBjYWxsYmFjazogKGVyciwgZW50cnk6IE1hbmlmZXN0KTogdm9pZCA9PiB7XG4gICAgICAgICAgICBpZiAoIWVyciAmJiBlbnRyeSkge1xuICAgICAgICAgICAgICBhdXRoLmFsbG93X2FjY2VzcyhcbiAgICAgICAgICAgICAgICB7IHBhY2thZ2VOYW1lOiBlbnRyeS5uYW1lIH0sXG4gICAgICAgICAgICAgICAgcmVxLnJlbW90ZV91c2VyLFxuICAgICAgICAgICAgICAgIGZ1bmN0aW9uIChlcnIsIGFsbG93ZWQpOiB2b2lkIHtcbiAgICAgICAgICAgICAgICAgIGlmIChlcnIgfHwgIWFsbG93ZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICBwYWNrYWdlcy5wdXNoKGVudHJ5LnZlcnNpb25zW2VudHJ5W0RJU1RfVEFHU10ubGF0ZXN0XSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoaSA+PSByZXN1bHRzLmxlbmd0aCAtIDEpIHtcbiAgICAgICAgICAgICAgbmV4dChwYWNrYWdlcyk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICBnZXRQYWNrYWdlSW5mbyhpICsgMSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSxcbiAgICAgICAgfSk7XG4gICAgICB9O1xuXG4gICAgICBpZiAocmVzdWx0cy5sZW5ndGgpIHtcbiAgICAgICAgZ2V0UGFja2FnZUluZm8oMCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBuZXh0KFtdKTtcbiAgICAgIH1cbiAgICB9XG4gICk7XG5cbiAgcmV0dXJuIHJvdXRlO1xufVxuXG5leHBvcnQgZGVmYXVsdCBhZGRTZWFyY2hXZWJBcGk7XG4iXSwibWFwcGluZ3MiOiI7Ozs7OztBQUVBLElBQUFBLGNBQUEsR0FBQUMsT0FBQTtBQUlBLElBQUFDLFVBQUEsR0FBQUQsT0FBQTtBQUlBLFNBQVNFLGVBQWVBLENBQUNDLEtBQWEsRUFBRUMsT0FBZ0IsRUFBRUMsSUFBVSxFQUFVO0VBQzVFO0VBQ0FGLEtBQUssQ0FBQ0csR0FBRyxDQUNQLG9DQUFvQyxFQUNwQyxnQkFDRUMsR0FBbUIsRUFDbkJDLElBQXFCLEVBQ3JCQyxJQUFzQixFQUNQO0lBQ2YsTUFBTUMsSUFBSSxHQUFHSCxHQUFHLENBQUNJLE1BQU0sQ0FBQ0MsUUFBUTtJQUNoQyxNQUFNQyxPQUFPLEdBQUksTUFBTUMsa0NBQW1CLENBQUNDLEtBQUssQ0FBQ0wsSUFBSSxDQUFTO0lBQzlELE1BQU1NLFFBQWUsR0FBRyxFQUFFO0lBQzFCLE1BQU1DLE9BQU8sR0FBR0osT0FBTyxDQUFDSyxJQUFJO0lBRTVCLE1BQU1DLGNBQWMsR0FBRyxTQUFBQSxDQUFVQyxDQUFDLEVBQVE7TUFDeENoQixPQUFPLENBQUNpQixVQUFVLENBQUM7UUFDakJDLElBQUksRUFBRUwsT0FBTyxDQUFDRyxDQUFDLENBQUMsQ0FBQ0csRUFBRTtRQUNuQkMsV0FBVyxFQUFFLEtBQUs7UUFDbEJDLFFBQVEsRUFBRUEsQ0FBQ0MsR0FBRyxFQUFFQyxLQUFlLEtBQVc7VUFDeEMsSUFBSSxDQUFDRCxHQUFHLElBQUlDLEtBQUssRUFBRTtZQUNqQnRCLElBQUksQ0FBQ3VCLFlBQVksQ0FDZjtjQUFFQyxXQUFXLEVBQUVGLEtBQUssQ0FBQ0w7WUFBSyxDQUFDLEVBQzNCZixHQUFHLENBQUN1QixXQUFXLEVBQ2YsVUFBVUosR0FBRyxFQUFFSyxPQUFPLEVBQVE7Y0FDNUIsSUFBSUwsR0FBRyxJQUFJLENBQUNLLE9BQU8sRUFBRTtnQkFDbkI7Y0FDRjtjQUVBZixRQUFRLENBQUNnQixJQUFJLENBQUNMLEtBQUssQ0FBQ00sUUFBUSxDQUFDTixLQUFLLENBQUNPLG9CQUFTLENBQUMsQ0FBQ0MsTUFBTSxDQUFDLENBQUM7WUFDeEQsQ0FDRixDQUFDO1VBQ0g7VUFFQSxJQUFJZixDQUFDLElBQUlILE9BQU8sQ0FBQ21CLE1BQU0sR0FBRyxDQUFDLEVBQUU7WUFDM0IzQixJQUFJLENBQUNPLFFBQVEsQ0FBQztVQUNoQixDQUFDLE1BQU07WUFDTEcsY0FBYyxDQUFDQyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1VBQ3ZCO1FBQ0Y7TUFDRixDQUFDLENBQUM7SUFDSixDQUFDO0lBRUQsSUFBSUgsT0FBTyxDQUFDbUIsTUFBTSxFQUFFO01BQ2xCakIsY0FBYyxDQUFDLENBQUMsQ0FBQztJQUNuQixDQUFDLE1BQU07TUFDTFYsSUFBSSxDQUFDLEVBQUUsQ0FBQztJQUNWO0VBQ0YsQ0FDRixDQUFDO0VBRUQsT0FBT04sS0FBSztBQUNkO0FBQUMsSUFBQWtDLFFBQUEsR0FBQUMsT0FBQSxDQUFBQyxPQUFBLEdBRWNyQyxlQUFlIiwiaWdub3JlTGlzdCI6W119